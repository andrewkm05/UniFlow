{% extends "base.html" %}
{% block title %}Grades ~ UniFlow{% endblock %}

{% block content %}
<div class="container-xl grades-page" style="margin-top: 80px;">

    <!-- Header: Title + Overall + Add-->
    <div class="d-flex align-items-center justify-content-between mb-3">
        <div class="d-flex align-items-baseline gap-3">

            <h1 class="fw-bold display-6 text-uppercase">GRADES</h1>

            <span class="badge rounded-pill btn-primary-uf" style="font-size:.95rem; padding:.5rem .8rem;">
                Overall: {{ overall_avg if overall_avg is not none else '-' }}%
            </span>
        </div>

        <form action="{{ url_for('grades_module_add' )}}" method="post" class="m-0">
            <button type="submit" class="btn btn-primary-uf rounded-pill px-4">
                Add Module +
            </button>
        </form>
    </div>

    {% if not modules_by_term %}
        <div class="alert alert-info">No modules yet. Click <strong>Add Module +</strong> to get started</div>
    {% endif %}

    <!-- Terms cards -->
    <div class="d-flex flex-column gap-3">

        {% for term, mods in modules_by_term|dictsort %}
            <div class="term card shadow-sm border-0" data-term="{{ term }}">

                <!-- Term header - toggle-->
                <div class="card-header term-header d-flex align-items-center justify-content-between" role="button" aria-expanded="false" aria-controls="term-body-{{ term }}">
                    <div class="d-flex align-items-center gap-3">

                        <h5 class="mb-0"> Term {{ term }}</h5>

                    </div>

                    <!-- Add module in the term -->
                    <form action="{{ url_for('grades_module_add') }}?term={{ term }}" method="post" class="m-0" onclick="event.stopPropagation()">
                        <button type="submit" class="btn btn-actions rounded-pill">
                            Add +
                        </button>
                    </form>
                </div>

                <!-- Term body (hidden at first place) -->
                <div class="term-body p-3" id="term-body-{{ term }}" hidden>
                    <div class="d-flex flex-column gap-2">

                        {% for m in mods %}

                        <!-- Module card -->
                        <div class="module card border-0 shadow-sm" data-module-id="{{ m.id }}">

                            <!-- Module header (toggle) -->
                            <button type="button" class="module-toggle btn w-100 text-start p-3" aria-expanded="false" aria-controls="module-body-{{ m.id }}"
                                    style="background: #fff; border:none;">
                            
                                <div class="d-flex align-items-center justify-content-between">
                                    <div class="d-flex align-items-center gap-3">

                                        <strong class="fs-5">{{ m.name }}</strong>

                                        <span class="badge text-bg-light text-muted">CATS {{ m.credits }}</span>
                                    </div>

                                    <div class="d-flex align-items-center gap-3">
                                        <small class="text-muted">Total weight(%): <span class="mod-total-weight">{{ m.total_weight }}</span>%</small>                                        
                                    </div>
                                </div>
                            </button>

                            <!-- Module's body (hidden at first place) -->
                            <div class="module-body pt-3 pt-0" id="module-body-{{ m.id }}" hidden>

                                <!-- Toggle for module SETTINGS (collapsed by default) -->
                                <div class="d-flex justify-content-end mb-2">
                                    <button class="btn btn-actions rounded-pill" style="width: 150px;"
                                            type="button"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#mod-settings-{{ m.id }}"
                                            aria-expanded="false"
                                            aria-controls="mod-settings-{{ m.id }}">
                                    Edit module settings
                                    </button>
                                </div>

                                <!-- MODULE SETTINGS (collapse) -->
                                <div class="collapse" id="mod-settings-{{ m.id }}">
                                    <!-- Update form -->
                                    <form action="{{ url_for('grades_module_update', module_id=m.id) }}" method="post" class="row g-2 mb-2" id="upd-{{ m.id }}"></form>

                                    <div class="table-wrap module-settings mb-3">
                                        <table class="applies-table grades-table grades-table--modules">
                                            <thead>
                                                <tr>
                                                    <th class="col-title">Module Name</th>
                                                    <th class="col-term">Term</th>
                                                    <th class="col-credits">CATS</th>
                                                    <th class="col-actions">Actions</th>
                                                </tr>
                                            </thead>

                                            <tbody>
                                                <tr>
                                                    <!--Name-->
                                                    <td class="col-title">
                                                        <input class="form-control" name="name" value="{{ m.name }}" required form="upd-{{ m.id }}">
                                                    </td>

                                                    <!-- Term -->
                                                    <td class="align-middle col-term">
                                                        <select class="form-control" name="term" required form="upd-{{ m.id }}">
                                                            {% for t in range(1,13) %}
                                                                <option value="{{ t }}" {{ 'selected' if m.term==t else '' }}>Term {{ t }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </td>

                                                    <!-- Credits -->
                                                    <td class="align-middle col-credits">
                                                        <input class="form-control" type="number" name="credits" min="0.5" step="0.5" value="{{ m.credits }}" required form="upd-{{ m.id }}">
                                                    </td>

                                                    <!-- Actions -->
                                                    <td class="align-middle col-actions">
                                                        <div class="d-flex flex-column gap-2">
                                                            <button class="btn btn-pill btn-actions" type="submit" form="upd-{{ m.id }}">
                                                                Save
                                                            </button>

                                                            <form action="{{ url_for('grades_module_delete', module_id=m.id) }}" method="post" onsubmit="return confirm('Delete module and its assessments?');">
                                                                <button class="btn btn-pill btn-actions" type="submit">Delete</button>
                                                            </form>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>                            
                                </div> 
                                

                                <!-- Assessments table -->
                                <div class="table-wrap" style="margin-top: 10px;">
                                    <table class="applies-table grades-table grades-table--assessments">
                                        <thead>
                                            <tr>
                                                <th class="col-title">Assessment Title</th>
                                                <th class="col-weight">Weight(%)</th>
                                                <th class="col-score">Score</th>
                                                <th class="col-actions">Actions</th>
                                            </tr>
                                        </thead>

                                        <tbody>
                                            {% for a in assessments_by_module.get(m.id, []) %}
                                            <tr>
                                                <!-- Title -->                                    
                                                <td class="col-title">
                                                    <input class="form-control" name="title" value="{{ a.title }}" required form="ass-upd-{{ a.id }}">
                                                </td>

                                                <!-- Weight -->
                                                <td class="align-middle col-weight">
                                                    <input class="form-control js-weight" type="number" name="weight_pct" value="{{ a.weight_pct }}" min="0" max="100" step="0.5" required form="ass-upd-{{ a.id }}">
                                                </td>

                                                <!-- Score -->
                                                <td class="align-middle col-score">
                                                    <input class="form-control js-score" type="number" name="score_pct" value="{{ a.score_pct if a.score_pct is not none else '' }}" min="0" max="100" step="0.5" form="ass-upd-{{ a.id }}">
                                                </td>

                                                <!-- Actions -->
                                                <td class="align-middle col-actions">
                                                    <form action="{{ url_for('grades_assessment_update', assessment_id=a.id) }}" method="post" class="row g-2 js-assessment" id="ass-upd-{{ a.id }}"></form>
                                                    
                                                    <div class="row-actions">
                                                        <button class="btn btn-pill btn-actions" type="submit" form="ass-upd-{{ a.id }}">
                                                            Save
                                                        </button>

                                                        <form action="{{ url_for('grades_assessment_delete', assessment_id=a.id) }}" method="post" onsubmit="return confirm('Delete this assessment?');">
                                                            <button class="btn btn-pill btn-actions" type="submit">
                                                                Delete
                                                            </button>
                                                        </form>
                                                    </div> 
                                                </td>                                        
                                            </tr>
                                            {% endfor %}

                                            <!-- Add assessment -->
                                            <tr class="bg-body-secondary-subtle">
                                                <td>
                                                    <input class="form-control" name="title" placeholder="Assessment title" required form="ass-new-{{ m.id }}">
                                                </td>

                                                <td class="align-middle">
                                                    <input class="form-control js-weight" type="number" name="weight_pct" placeholder="e.g. 30" min="0" max="100" step="0.5" required form="ass-new-{{ m.id }}">
                                                </td>

                                                <td class="align-middle">
                                                    <input class="form-control js-score" type="number" name="score_pct" placeholder="e.g. 75" min="0" max="100" step="0.5" form="ass-new-{{ m.id }}">
                                                </td>

                                                <td class="align-middle">
                                                    <form action="{{ url_for('grades_assessment_create', module_id=m.id) }}" method="post" class="row g-2 js-assessment" id="ass-new-{{ m.id }}"></form>

                                                    <div class="row-actions">
                                                        <button class="btn btn-pill btn-actions" type="submit" form="ass-new-{{ m.id }}">
                                                            Save
                                                        </button>
                                                    </div>
                                                </td>                                            
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Summary row -->
                                <div class="d-flex justify-content-between small text-muted px-1 pt-2">
                                    <span>Total weight(%) (live): <strong class="mod-weight-live">-</strong>%</span>
                                    <span>Module grade (preview): <strong class="mod-grade-live">-</strong>%</span>
                                </div>                        
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- Across Terms (overall per course grade)-->
    {% if courses_overall %}
        <div class="mt-4">
            <div class="d-flex align-items-center justify-content-between mb-2">

                <!-- Title -->
                <h5 class="text-uppercase mb-0">Across Terms</h5>
            </div>

            <div class="row g-3">
                {% for c in courses_overall %}
                    <div class="col-12 col-sm-6 col-lg-4 col-xl-3">
                        <div class="card shadow-sm border-0 h-100">
                            <div class="card-body d-flex flex-column gap-2">

                                <!-- Course title and overall grade -->
                                <div class="d-flex align-items-center justify-content-between">
                                    <strong class="text-truncate">{{ c.name }}</strong>

                                    <span class="badge rounded-pill btn-primary-uf">
                                        {{ c.overall is not none and (c.overall|string + '%') or '' }}
                                    </span>
                                </div>

                                <!-- Terms and CATS -->
                                <div class="small text-muted">
                                    {{ c.terms_count }} term{{ 1 if c.terms_count == 1 else 's' }} ({{ c.ects_total / c.terms_count }} CATS)
                                </div>

                                {% if c.per_terms %}
                                    <div class="d-flex flex-wrap gap-2">
                                        {% for pt in c.per_terms %}
                                            <span class="badge text-bg-light">
                                                Term {{ pt.term }}:
                                                <strong>{{ pt.grade is not none and (pt.grade|string +'%') or '-' }}</strong>
                                            </span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}
</div>

<script src="{{ url_for('static', filename='js/grades.js') }}" defer></script>

{% endblock %}